import { __awaiter } from "tslib";
import { commandNames, eventNames, filterType, historyNames } from './consts';
export function isFileApiSupported() {
    return !!(window.File && window.FileList && window.FileReader);
}
export function isSilentCommand(command) {
    return typeof command === 'string'
        ? commandNames.LOAD_IMAGE === command
        : commandNames.LOAD_IMAGE === command.name;
}
export function getHistoryTitle(command) {
    const { FLIP_IMAGE, ROTATE_IMAGE, ADD_TEXT, APPLY_FILTER, REMOVE_FILTER, CHANGE_SHAPE, CHANGE_ICON_COLOR, CHANGE_TEXT_STYLE, CLEAR_OBJECTS, ADD_IMAGE_OBJECT, REMOVE_OBJECT, } = commandNames;
    const { name, args } = command;
    let historyInfo;
    switch (name) {
        case FLIP_IMAGE:
            historyInfo = {
                name,
                detail: args[1] === 'reset' ? args[1] : args[1].slice(4),
            };
            break;
        case ROTATE_IMAGE:
            historyInfo = { name, detail: args[2] };
            break;
        case APPLY_FILTER:
            historyInfo = {
                name: historyNames.APPLY_FILTER,
                detail: getFilterType(args[1], args[2]),
            };
            break;
        case REMOVE_FILTER:
            historyInfo = { name: historyNames.REMOVE_FILTER, detail: args[1] };
            break;
        case CHANGE_SHAPE:
            historyInfo = { name: historyNames.CHANGE_SHAPE, detail: 'Change' };
            break;
        case CHANGE_ICON_COLOR:
            historyInfo = { name: historyNames.CHANGE_ICON_COLOR, detail: 'Change' };
            break;
        case CHANGE_TEXT_STYLE:
            historyInfo = { name: historyNames.CHANGE_TEXT_STYLE, detail: 'Change' };
            break;
        case REMOVE_OBJECT:
            historyInfo = { name: historyNames.REMOVE_OBJECT, detail: args[2] };
            break;
        case CLEAR_OBJECTS:
            historyInfo = { name: historyNames.CLEAR_OBJECTS, detail: 'All' };
            break;
        case ADD_IMAGE_OBJECT:
            historyInfo = { name: historyNames.ADD_IMAGE_OBJECT, detail: 'Add' };
            break;
        case ADD_TEXT:
            historyInfo = { name: historyNames.ADD_TEXT };
            break;
        default:
            historyInfo = { name };
            break;
    }
    if (args[1] === 'mask') {
        historyInfo = { name: historyNames.LOAD_MASK_IMAGE, detail: 'Apply' };
    }
    return historyInfo;
}
export function getFilterType(type, { useAlpha = true, mode = null } = {}) {
    const { VINTAGE, REMOVE_COLOR, BLEND_COLOR, SEPIA2, COLOR_FILTER, REMOVE_WHITE, BLEND, } = filterType;
    let filterName;
    switch (type) {
        case VINTAGE:
            filterName = SEPIA2;
            break;
        case REMOVE_COLOR:
            filterName = useAlpha ? COLOR_FILTER : REMOVE_WHITE;
            break;
        case BLEND_COLOR:
            filterName = mode === 'add' ? BLEND : mode;
            break;
        default:
            filterName = type;
    }
    return toStartOfCapital(filterName);
}
function toStartOfCapital(str) {
    return str.replace(/[a-z]/, (first) => first.toUpperCase());
}
export function dataUrlToBlob(dataUrl) {
    const { groups: { mime, base64data }, } = /data:(?<mime>.+);base64,(?<base64data>.+)/.exec(dataUrl);
    const byteCharacters = atob(base64data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: mime });
}
export const emptyCropRectValues = {
    LEFT: 0,
    TOP: 0,
    WIDTH: 0.5,
    HEIGHT: 0.5,
};
/**
 * Check if cropRect is Empty.
 * @param {Object} cropRect - cropRect object
 *  @param {Number} cropRect.left - cropRect left position value
 *  @param {Number} cropRect.top - cropRect top position value
 *  @param {Number} cropRect.width - cropRect width value
 *  @param {Number} cropRect.height - cropRect height value
 * @returns {boolean}
 */
export function isEmptyCropzone(cropRect) {
    const { left, top, width, height } = cropRect;
    const { LEFT, TOP, WIDTH, HEIGHT } = emptyCropRectValues;
    return left === LEFT && top === TOP && width === WIDTH && height === HEIGHT;
}
export function clearSelection(imageEditor, fire_event = true) {
    imageEditor.discardSelection();
    if (fire_event) {
        imageEditor.fire(eventNames.OBJECT_ACTIVATED, null);
        imageEditor.fire(eventNames.SELECTION_CLEARED, null);
    }
}
export function getActiveObjectId(imageEditor) {
    if (imageEditor != null) {
        let activeObject = imageEditor._graphics.getActiveObject();
        if (activeObject) {
            let activeObjectId = imageEditor._graphics.getObjectId(activeObject);
            return activeObjectId;
        }
    }
    return null;
}
export function removeFilter(imageEditor, type, isSilent) {
    return __awaiter(this, void 0, void 0, function* () {
        if (imageEditor != null) {
            if (isSilent) {
                yield imageEditor.executeSilent('removeFilter', type);
            }
            else {
                yield imageEditor.execute('removeFilter', type);
            }
        }
    });
}
export function rgbaToObject(rgba) {
    if (rgba.startsWith('rgba')) {
        const { groups: { r, g, b, a }, } = /rgba\(\s*(?<r>\d+)\s*,\s*(?<g>\d+)\s*,\s*(?<b>\d+)\s*,\s*(?<a>[0-9.]+)\s*\)/.exec(rgba);
        let parsedR = parseInt(r);
        let parsedG = parseInt(g);
        let parsedB = parseInt(b);
        return {
            r: parsedR,
            g: parsedG,
            b: parsedB,
            hexString: `#${(parsedR <= 15 ? '0' : '') + parsedR.toString(16)}${(parsedG <= 15 ? '0' : '') + parsedG.toString(16)}${(parsedB <= 15 ? '0' : '') + parsedB.toString(16)}`,
            alpha: parseFloat(a),
        };
    }
    return rgbToObject(rgba);
}
export function rgbToObject(rgb) {
    if (rgb.startsWith('rgb')) {
        const { groups: { r, g, b }, } = /rgb\(\s*(?<r>\d+)\s*,\s*(?<g>\d+)\s*,\s*(?<b>\d+)\s*\)/.exec(rgb);
        let parsedR = parseInt(r);
        let parsedG = parseInt(g);
        let parsedB = parseInt(b);
        return {
            r: parsedR,
            g: parsedG,
            b: parsedB,
            hexString: `#${(parsedR <= 15 ? '0' : '') + parsedR.toString(16)}${(parsedG <= 15 ? '0' : '') + parsedG.toString(16)}${(parsedB <= 15 ? '0' : '') + parsedB.toString(16)}`,
            alpha: 1,
        };
    }
    return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy90dWktaW1hZ2UtZWRpdG9yLWFuZ3VsYXIvc3JjL2xpYi91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUc5RSxNQUFNLFVBQVUsa0JBQWtCO0lBQ2hDLE9BQU8sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsUUFBUSxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNqRSxDQUFDO0FBRUQsTUFBTSxVQUFVLGVBQWUsQ0FBQyxPQUF5QjtJQUN2RCxPQUFPLE9BQU8sT0FBTyxLQUFLLFFBQVE7UUFDaEMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxVQUFVLEtBQUssT0FBTztRQUNyQyxDQUFDLENBQUMsWUFBWSxDQUFDLFVBQVUsS0FBSyxPQUFPLENBQUMsSUFBSSxDQUFDO0FBQy9DLENBQUM7QUFFRCxNQUFNLFVBQVUsZUFBZSxDQUFDLE9BQU87SUFDckMsTUFBTSxFQUNKLFVBQVUsRUFDVixZQUFZLEVBQ1osUUFBUSxFQUNSLFlBQVksRUFDWixhQUFhLEVBQ2IsWUFBWSxFQUNaLGlCQUFpQixFQUNqQixpQkFBaUIsRUFDakIsYUFBYSxFQUNiLGdCQUFnQixFQUNoQixhQUFhLEdBQ2QsR0FBRyxZQUFZLENBQUM7SUFDakIsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFDL0IsSUFBSSxXQUFXLENBQUM7SUFFaEIsUUFBUSxJQUFJLEVBQUU7UUFDWixLQUFLLFVBQVU7WUFDYixXQUFXLEdBQUc7Z0JBQ1osSUFBSTtnQkFDSixNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENB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QUFDO0tBQ0g7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb21tYW5kTmFtZXMsIGV2ZW50TmFtZXMsIGZpbHRlclR5cGUsIGhpc3RvcnlOYW1lcyB9IGZyb20gJy4vY29uc3RzJztcbmltcG9ydCB7IENvbW1hbmQgfSBmcm9tICcuL2ludGVyZmFjZXMvY29tbWFuZCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpbGVBcGlTdXBwb3J0ZWQoKTogYm9vbGVhbiB7XG4gIHJldHVybiAhISh3aW5kb3cuRmlsZSAmJiB3aW5kb3cuRmlsZUxpc3QgJiYgd2luZG93LkZpbGVSZWFkZXIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTaWxlbnRDb21tYW5kKGNvbW1hbmQ6IHN0cmluZyB8IENvbW1hbmQpIHtcbiAgcmV0dXJuIHR5cGVvZiBjb21tYW5kID09PSAnc3RyaW5nJ1xuICAgID8gY29tbWFuZE5hbWVzLkxPQURfSU1BR0UgPT09IGNvbW1hbmRcbiAgICA6IGNvbW1hbmROYW1lcy5MT0FEX0lNQUdFID09PSBjb21tYW5kLm5hbWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRIaXN0b3J5VGl0bGUoY29tbWFuZCk6IHsgbmFtZTogc3RyaW5nOyBkZXRhaWw6IGFueSB9IHtcbiAgY29uc3Qge1xuICAgIEZMSVBfSU1BR0UsXG4gICAgUk9UQVRFX0lNQUdFLFxuICAgIEFERF9URVhULFxuICAgIEFQUExZX0ZJTFRFUixcbiAgICBSRU1PVkVfRklMVEVSLFxuICAgIENIQU5HRV9TSEFQRSxcbiAgICBDSEFOR0VfSUNPTl9DT0xPUixcbiAgICBDSEFOR0VfVEVYVF9TVFlMRSxcbiAgICBDTEVBUl9PQkpFQ1RTLFxuICAgIEFERF9JTUFHRV9PQkpFQ1QsXG4gICAgUkVNT1ZFX09CSkVDVCxcbiAgfSA9IGNvbW1hbmROYW1lcztcbiAgY29uc3QgeyBuYW1lLCBhcmdzIH0gPSBjb21tYW5kO1xuICBsZXQgaGlzdG9yeUluZm87XG5cbiAgc3dpdGNoIChuYW1lKSB7XG4gICAgY2FzZSBGTElQX0lNQUdFOlxuICAgICAgaGlzdG9yeUluZm8gPSB7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGRldGFpbDogYXJnc1sxXSA9PT0gJ3Jlc2V0JyA/IGFyZ3NbMV0gOiBhcmdzWzFdLnNsaWNlKDQpLFxuICAgICAgfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUk9UQVRFX0lNQUdFOlxuICAgICAgaGlzdG9yeUluZm8gPSB7IG5hbWUsIGRldGFpbDogYXJnc1syXSB9O1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBBUFBMWV9GSUxURVI6XG4gICAgICBoaXN0b3J5SW5mbyA9IHtcbiAgICAgICAgbmFtZTogaGlzdG9yeU5hbWVzLkFQUExZX0ZJTFRFUixcbiAgICAgICAgZGV0YWlsOiBnZXRGaWx0ZXJUeXBlKGFyZ3NbMV0sIGFyZ3NbMl0pLFxuICAgICAgfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUkVNT1ZFX0ZJTFRFUjpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lOiBoaXN0b3J5TmFtZXMuUkVNT1ZFX0ZJTFRFUiwgZGV0YWlsOiBhcmdzWzFdIH07XG4gICAgICBicmVhaztcbiAgICBjYXNlIENIQU5HRV9TSEFQRTpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lOiBoaXN0b3J5TmFtZXMuQ0hBTkdFX1NIQVBFLCBkZXRhaWw6ICdDaGFuZ2UnIH07XG4gICAgICBicmVhaztcbiAgICBjYXNlIENIQU5HRV9JQ09OX0NPTE9SOlxuICAgICAgaGlzdG9yeUluZm8gPSB7IG5hbWU6IGhpc3RvcnlOYW1lcy5DSEFOR0VfSUNPTl9DT0xPUiwgZGV0YWlsOiAnQ2hhbmdlJyB9O1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBDSEFOR0VfVEVYVF9TVFlMRTpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lOiBoaXN0b3J5TmFtZXMuQ0hBTkdFX1RFWFRfU1RZTEUsIGRldGFpbDogJ0NoYW5nZScgfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUkVNT1ZFX09CSkVDVDpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lOiBoaXN0b3J5TmFtZXMuUkVNT1ZFX09CSkVDVCwgZGV0YWlsOiBhcmdzWzJdIH07XG4gICAgICBicmVhaztcbiAgICBjYXNlIENMRUFSX09CSkVDVFM6XG4gICAgICBoaXN0b3J5SW5mbyA9IHsgbmFtZTogaGlzdG9yeU5hbWVzLkNMRUFSX09CSkVDVFMsIGRldGFpbDogJ0FsbCcgfTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgQUREX0lNQUdFX09CSkVDVDpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lOiBoaXN0b3J5TmFtZXMuQUREX0lNQUdFX09CSkVDVCwgZGV0YWlsOiAnQWRkJyB9O1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBBRERfVEVYVDpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lOiBoaXN0b3J5TmFtZXMuQUREX1RFWFQgfTtcbiAgICAgIGJyZWFrO1xuXG4gICAgZGVmYXVsdDpcbiAgICAgIGhpc3RvcnlJbmZvID0geyBuYW1lIH07XG4gICAgICBicmVhaztcbiAgfVxuXG4gIGlmIChhcmdzWzFdID09PSAnbWFzaycpIHtcbiAgICBoaXN0b3J5SW5mbyA9IHsgbmFtZTogaGlzdG9yeU5hbWVzLkxPQURfTUFTS19JTUFHRSwgZGV0YWlsOiAnQXBwbHknIH07XG4gIH1cblxuICByZXR1cm4gaGlzdG9yeUluZm87XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWx0ZXJUeXBlKFxuICB0eXBlOiBzdHJpbmcsXG4gIHsgdXNlQWxwaGEgPSB0cnVlLCBtb2RlID0gbnVsbCB9ID0ge31cbik6IHN0cmluZyB7XG4gIGNvbnN0IHtcbiAgICBWSU5UQUdFLFxuICAgIFJFTU9WRV9DT0xPUixcbiAgICBCTEVORF9DT0xPUixcbiAgICBTRVBJQTIsXG4gICAgQ09MT1JfRklMVEVSLFxuICAgIFJFTU9WRV9XSElURSxcbiAgICBCTEVORCxcbiAgfSA9IGZpbHRlclR5cGU7XG5cbiAgbGV0IGZpbHRlck5hbWU7XG5cbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSBWSU5UQUdFOlxuICAgICAgZmlsdGVyTmFtZSA9IFNFUElBMjtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUkVNT1ZFX0NPTE9SOlxuICAgICAgZmlsdGVyTmFtZSA9IHVzZUFscGhhID8gQ09MT1JfRklMVEVSIDogUkVNT1ZFX1dISVRFO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBCTEVORF9DT0xPUjpcbiAgICAgIGZpbHRlck5hbWUgPSBtb2RlID09PSAnYWRkJyA/IEJMRU5EIDogbW9kZTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICBmaWx0ZXJOYW1lID0gdHlwZTtcbiAgfVxuXG4gIHJldHVybiB0b1N0YXJ0T2ZDYXBpdGFsKGZpbHRlck5hbWUpO1xufVxuXG5mdW5jdGlvbiB0b1N0YXJ0T2ZDYXBpdGFsKHN0cik6IHN0cmluZyB7XG4gIHJldHVybiBzdHIucmVwbGFjZSgvW2Etel0vLCAoZmlyc3QpID0+IGZpcnN0LnRvVXBwZXJDYXNlKCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGF0YVVybFRvQmxvYihkYXRhVXJsOiBzdHJpbmcpOiBCbG9iIHtcbiAgY29uc3Qge1xuICAgIGdyb3VwczogeyBtaW1lLCBiYXNlNjRkYXRhIH0sXG4gIH0gPSAvZGF0YTooPzxtaW1lPi4rKTtiYXNlNjQsKD88YmFzZTY0ZGF0YT4uKykvLmV4ZWMoZGF0YVVybCk7XG5cbiAgY29uc3QgYnl0ZUNoYXJhY3RlcnMgPSBhdG9iKGJhc2U2NGRhdGEpO1xuICBjb25zdCBieXRlTnVtYmVycyA9IG5ldyBBcnJheShieXRlQ2hhcmFjdGVycy5sZW5ndGgpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGJ5dGVDaGFyYWN0ZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgYnl0ZU51bWJlcnNbaV0gPSBieXRlQ2hhcmFjdGVycy5jaGFyQ29kZUF0KGkpO1xuICB9XG4gIGNvbnN0IGJ5dGVBcnJheSA9IG5ldyBVaW50OEFycmF5KGJ5dGVOdW1iZXJzKTtcbiAgcmV0dXJuIG5ldyBCbG9iKFtieXRlQXJyYXldLCB7IHR5cGU6IG1pbWUgfSk7XG59XG5cbmV4cG9ydCBjb25zdCBlbXB0eUNyb3BSZWN0VmFsdWVzID0ge1xuICBMRUZUOiAwLFxuICBUT1A6IDAsXG4gIFdJRFRIOiAwLjUsXG4gIEhFSUdIVDogMC41LFxufTtcblxuLyoqXG4gKiBDaGVjayBpZiBjcm9wUmVjdCBpcyBFbXB0eS5cbiAqIEBwYXJhbSB7T2JqZWN0fSBjcm9wUmVjdCAtIGNyb3BSZWN0IG9iamVjdFxuICogIEBwYXJhbSB7TnVtYmVyfSBjcm9wUmVjdC5sZWZ0IC0gY3JvcFJlY3QgbGVmdCBwb3NpdGlvbiB2YWx1ZVxuICogIEBwYXJhbSB7TnVtYmVyfSBjcm9wUmVjdC50b3AgLSBjcm9wUmVjdCB0b3AgcG9zaXRpb24gdmFsdWVcbiAqICBAcGFyYW0ge051bWJlcn0gY3JvcFJlY3Qud2lkdGggLSBjcm9wUmVjdCB3aWR0aCB2YWx1ZVxuICogIEBwYXJhbSB7TnVtYmVyfSBjcm9wUmVjdC5oZWlnaHQgLSBjcm9wUmVjdCBoZWlnaHQgdmFsdWVcbiAqIEByZXR1cm5zIHtib29sZWFufVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNFbXB0eUNyb3B6b25lKGNyb3BSZWN0KSB7XG4gIGNvbnN0IHsgbGVmdCwgdG9wLCB3aWR0aCwgaGVpZ2h0IH0gPSBjcm9wUmVjdDtcbiAgY29uc3QgeyBMRUZULCBUT1AsIFdJRFRILCBIRUlHSFQgfSA9IGVtcHR5Q3JvcFJlY3RWYWx1ZXM7XG5cbiAgcmV0dXJuIGxlZnQgPT09IExFRlQgJiYgdG9wID09PSBUT1AgJiYgd2lkdGggPT09IFdJRFRIICYmIGhlaWdodCA9PT0gSEVJR0hUO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJTZWxlY3Rpb24oaW1hZ2VFZGl0b3I6IGFueSwgZmlyZV9ldmVudDogYm9vbGVhbiA9IHRydWUpIHtcbiAgaW1hZ2VFZGl0b3IuZGlzY2FyZFNlbGVjdGlvbigpO1xuICBpZiAoZmlyZV9ldmVudCkge1xuICAgIGltYWdlRWRpdG9yLmZpcmUoZXZlbnROYW1lcy5PQkpFQ1RfQUNUSVZBVEVELCBudWxsKTtcbiAgICBpbWFnZUVkaXRvci5maXJlKGV2ZW50TmFtZXMuU0VMRUNUSU9OX0NMRUFSRUQsIG51bGwpOyAgICBcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QWN0aXZlT2JqZWN0SWQoaW1hZ2VFZGl0b3I6IGFueSk6IG51bWJlciB8IG51bGwge1xuICBpZiAoaW1hZ2VFZGl0b3IgIT0gbnVsbCkge1xuICAgIGxldCBhY3RpdmVPYmplY3QgPSBpbWFnZUVkaXRvci5fZ3JhcGhpY3MuZ2V0QWN0aXZlT2JqZWN0KCk7XG4gICAgaWYgKGFjdGl2ZU9iamVjdCkge1xuICAgICAgbGV0IGFjdGl2ZU9iamVjdElkID0gaW1hZ2VFZGl0b3IuX2dyYXBoaWNzLmdldE9iamVjdElkKGFjdGl2ZU9iamVjdCk7XG4gICAgICByZXR1cm4gYWN0aXZlT2JqZWN0SWQ7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVtb3ZlRmlsdGVyKFxuICBpbWFnZUVkaXRvcjogYW55LFxuICB0eXBlOiBzdHJpbmcsXG4gIGlzU2lsZW50OiBib29sZWFuXG4pIHtcbiAgaWYgKGltYWdlRWRpdG9yICE9IG51bGwpIHtcbiAgICBpZiAoaXNTaWxlbnQpIHtcbiAgICAgIGF3YWl0IGltYWdlRWRpdG9yLmV4ZWN1dGVTaWxlbnQoJ3JlbW92ZUZpbHRlcicsIHR5cGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBpbWFnZUVkaXRvci5leGVjdXRlKCdyZW1vdmVGaWx0ZXInLCB0eXBlKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJnYmFUb09iamVjdChcbiAgcmdiYTogc3RyaW5nXG4pOiB7IHI6IG51bWJlcjsgZzogbnVtYmVyOyBiOiBudW1iZXI7IGhleFN0cmluZzogc3RyaW5nOyBhbHBoYTogbnVtYmVyIH0ge1xuICBpZiAocmdiYS5zdGFydHNXaXRoKCdyZ2JhJykpIHtcbiAgICBjb25zdCB7XG4gICAgICBncm91cHM6IHsgciwgZywgYiwgYSB9LFxuICAgIH0gPSAvcmdiYVxcKFxccyooPzxyPlxcZCspXFxzKixcXHMqKD88Zz5cXGQrKVxccyosXFxzKig/PGI+XFxkKylcXHMqLFxccyooPzxhPlswLTkuXSspXFxzKlxcKS8uZXhlYyhcbiAgICAgIHJnYmFcbiAgICApO1xuXG4gICAgbGV0IHBhcnNlZFIgPSBwYXJzZUludChyKTtcbiAgICBsZXQgcGFyc2VkRyA9IHBhcnNlSW50KGcpO1xuICAgIGxldCBwYXJzZWRCID0gcGFyc2VJbnQoYik7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcjogcGFyc2VkUixcbiAgICAgIGc6IHBhcnNlZEcsXG4gICAgICBiOiBwYXJzZWRCLFxuICAgICAgaGV4U3RyaW5nOiBgIyR7KHBhcnNlZFIgPD0gMTUgPyAnMCcgOiAnJykgKyBwYXJzZWRSLnRvU3RyaW5nKDE2KX0ke1xuICAgICAgICAocGFyc2VkRyA8PSAxNSA/ICcwJyA6ICcnKSArIHBhcnNlZEcudG9TdHJpbmcoMTYpXG4gICAgICB9JHsocGFyc2VkQiA8PSAxNSA/ICcwJyA6ICcnKSArIHBhcnNlZEIudG9TdHJpbmcoMTYpfWAsXG4gICAgICBhbHBoYTogcGFyc2VGbG9hdChhKSxcbiAgICB9O1xuICB9XG4gIHJldHVybiByZ2JUb09iamVjdChyZ2JhKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJnYlRvT2JqZWN0KFxuICByZ2I6IHN0cmluZ1xuKTogeyByOiBudW1iZXI7IGc6IG51bWJlcjsgYjogbnVtYmVyOyBoZXhTdHJpbmc6IHN0cmluZzsgYWxwaGE6IG51bWJlciB9IHtcbiAgaWYgKHJnYi5zdGFydHNXaXRoKCdyZ2InKSkge1xuICAgIGNvbnN0IHtcbiAgICAgIGdyb3VwczogeyByLCBnLCBiIH0sXG4gICAgfSA9IC9yZ2JcXChcXHMqKD88cj5cXGQrKVxccyosXFxzKig/PGc+XFxkKylcXHMqLFxccyooPzxiPlxcZCspXFxzKlxcKS8uZXhlYyhyZ2IpO1xuXG4gICAgbGV0IHBhcnNlZFIgPSBwYXJzZUludChyKTtcbiAgICBsZXQgcGFyc2VkRyA9IHBhcnNlSW50KGcpO1xuICAgIGxldCBwYXJzZWRCID0gcGFyc2VJbnQoYik7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcjogcGFyc2VkUixcbiAgICAgIGc6IHBhcnNlZEcsXG4gICAgICBiOiBwYXJzZWRCLFxuICAgICAgaGV4U3RyaW5nOiBgIyR7KHBhcnNlZFIgPD0gMTUgPyAnMCcgOiAnJykgKyBwYXJzZWRSLnRvU3RyaW5nKDE2KX0ke1xuICAgICAgICAocGFyc2VkRyA8PSAxNSA/ICcwJyA6ICcnKSArIHBhcnNlZEcudG9TdHJpbmcoMTYpXG4gICAgICB9JHsocGFyc2VkQiA8PSAxNSA/ICcwJyA6ICcnKSArIHBhcnNlZEIudG9TdHJpbmcoMTYpfWAsXG4gICAgICBhbHBoYTogMSxcbiAgICB9O1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuIl19